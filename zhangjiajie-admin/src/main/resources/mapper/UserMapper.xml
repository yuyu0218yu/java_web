<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhangjiajie.system.mapper.UserMapper">

    <!-- 带数据权限过滤的用户分页查询 -->
    <select id="selectUserPageWithDataScope" resultType="com.zhangjiajie.system.dto.UserWithRole">
        SELECT u.*, r.id as role_id, r.role_name, r.role_code, r.data_scope, d.dept_name
        FROM sys_user u
        LEFT JOIN sys_user_role ur ON u.id = ur.user_id AND ur.deleted = 0
        LEFT JOIN sys_role r ON ur.role_id = r.id AND r.deleted = 0
        LEFT JOIN sys_dept d ON u.dept_id = d.id AND d.deleted = 0
        WHERE u.deleted = 0
        <if test="username != null and username != ''">
            AND u.username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="email != null and email != ''">
            AND u.email LIKE CONCAT('%', #{email}, '%')
        </if>
        <if test="status != null">
            AND u.status = #{status}
        </if>
        <if test="deptId != null">
            AND u.dept_id = #{deptId}
        </if>
        <!-- 数据权限过滤SQL会在这里动态拼接 -->
        ${dataScopeSql}
        ORDER BY u.create_time DESC
    </select>

</mapper>
