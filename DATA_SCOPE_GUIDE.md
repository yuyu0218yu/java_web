# 数据权限管理指南

## 概述

本系统通过 **部门（Dept）**、**角色（Role）** 和 **用户（User）** 三者的关系来实现数据权限管理。理解这三者的关系对于正确配置系统权限至关重要。

## 核心概念

### 1. 部门（Department）

部门是组织结构的基本单位，采用树形结构：

```
张家界旅游公司（根部门）
├── 技术部
│   ├── 后端组
│   └── 前端组
├── 产品部
└── 运营部
```

**关键字段：**
- `dept_name`: 部门名称
- `dept_code`: 部门编码（唯一标识）
- `parent_id`: 父部门ID（0表示根部门）
- `ancestors`: 祖先节点列表（如：0,1,2），用于快速查询所有上级部门

**部门下级关系：**
- 技术部的下级包括：后端组、前端组
- 后端组、前端组的上级是技术部
- 根部门（parent_id=0）是最顶层组织

### 2. 角色（Role）

角色定义了用户在系统中的权限范围。每个角色都有一个 **数据范围（data_scope）** 字段，决定了该角色可以访问哪些数据。

**数据范围类型：**

#### 1) 全部数据（data_scope = 1）
- **说明**：可以查看和管理系统中所有部门的数据
- **适用场景**：超级管理员、系统管理员
- **示例**：超级管理员可以管理所有部门的所有用户
- **图示**：
  ```
  可访问范围: 全部
  张家界旅游公司 ✓
  ├── 技术部 ✓
  │   ├── 后端组 ✓
  │   └── 前端组 ✓
  ├── 产品部 ✓
  └── 运营部 ✓
  ```

#### 2) 本部门及下级（data_scope = 2）
- **说明**：可以查看和管理用户所在部门及其所有下级部门的数据
- **适用场景**：部门经理、团队Leader
- **示例**：技术部经理可以管理技术部、后端组、前端组的所有用户
- **图示**（假设用户在技术部）：
  ```
  可访问范围:
  张家界旅游公司 ✗
  ├── 技术部 ✓ (所在部门)
  │   ├── 后端组 ✓ (下级)
  │   └── 前端组 ✓ (下级)
  ├── 产品部 ✗
  └── 运营部 ✗
  ```

#### 3) 仅本部门（data_scope = 3）
- **说明**：只能查看和管理用户所在部门的数据，不包括下级部门
- **适用场景**：部门专员、部门管理员
- **示例**：技术部专员只能管理技术部的用户，不能管理后端组、前端组
- **图示**（假设用户在技术部）：
  ```
  可访问范围:
  张家界旅游公司 ✗
  ├── 技术部 ✓ (所在部门)
  │   ├── 后端组 ✗
  │   └── 前端组 ✗
  ├── 产品部 ✗
  └── 运营部 ✗
  ```

#### 4) 仅本人（data_scope = 4）
- **说明**：只能查看和管理自己创建的数据
- **适用场景**：普通员工、访客
- **示例**：普通用户只能查看和修改自己的数据
- **图示**：
  ```
  可访问范围: 仅本人数据
  ```

### 3. 用户（User）

用户是系统的使用者，每个用户必须：
1. 属于一个部门（通过 `dept_id` 关联）
2. 拥有一个或多个角色（通过 `sys_user_role` 关联表）

**用户的实际权限 = 角色权限 + 所在部门**

## 实际应用场景

### 场景1：部门经理管理下级

**需求：** 技术部经理需要管理技术部及所有下级（后端组、前端组）的员工

**配置：**
1. 创建角色 "技术部经理"
   - data_scope = 2（本部门及下级）
2. 创建用户 "张三"
   - dept_id = 技术部ID
   - role_id = 技术部经理角色ID

**结果：** 张三可以查看和管理：
- 技术部的所有用户
- 后端组的所有用户
- 前端组的所有用户

但不能访问产品部、运营部的数据。

### 场景2：部门专员管理本部门

**需求：** 后端组组长只需要管理后端组的员工，不需要管理其他组

**配置：**
1. 创建角色 "组长"
   - data_scope = 3（仅本部门）
2. 创建用户 "李四"
   - dept_id = 后端组ID
   - role_id = 组长角色ID

**结果：** 李四只能查看和管理后端组的用户，即使后端组有下级部门也无法访问。

### 场景3：普通员工

**需求：** 普通开发人员只能管理自己的数据

**配置：**
1. 创建角色 "普通员工"
   - data_scope = 4（仅本人）
2. 创建用户 "王五"
   - dept_id = 后端组ID
   - role_id = 普通员工角色ID

**结果：** 王五只能查看和修改自己的数据。

## 前端界面说明

### 用户管理界面

1. **部门列**：显示用户所属部门的完整路径
   - 示例：`张家界旅游公司/技术部/后端组`
   - 可以快速了解用户在组织中的位置

2. **数据范围列**：显示用户角色的数据权限范围
   - 全部：可管理所有数据
   - 本部门及下级：可管理本部门和下级部门
   - 仅本部门：只能管理本部门
   - 仅本人：只能管理自己的数据

3. **创建/编辑用户表单**：
   - **部门选择**：选择用户所属的部门（影响数据可见范围）
   - **角色选择**：选择用户角色（带有数据范围标签）
   - **数据权限说明**：实时显示所选角色的数据权限说明

### 角色管理界面

1. **数据范围选择**：创建/编辑角色时选择数据范围
   - 每个选项都有详细的说明
   - 带有颜色标识：
     - 红色（全部数据）：最高权限
     - 橙色（本部门及下级）：部门管理
     - 蓝色（仅本部门）：部门内
     - 灰色（仅本人）：个人

2. **数据权限说明**：实时显示所选数据范围的详细说明

### 部门管理界面

1. **部门树形结构**：清晰展示组织层级
   - 文件夹图标：有下级部门
   - 文档图标：没有下级部门
   - 显示下级数量：如 "2 个下级"

2. **新增子部门**：可以为任何部门添加下级部门

## 最佳实践

### 1. 部门设置

- 根据实际组织结构创建部门
- 使用清晰的部门编码（如：TECH、TECH_BE）
- 合理设置部门层级，避免过深（建议不超过4层）

### 2. 角色设置

- 根据管理范围创建不同的角色
- 使用描述性的角色名称（如：技术部经理、后端组长）
- 合理设置数据范围，遵循最小权限原则

### 3. 用户设置

- 每个用户必须分配到具体部门
- 根据用户职责分配合适的角色
- 定期审查用户权限，及时调整

## 常见问题

### Q1: 如何设置部门的下级？

**A:** 在部门管理界面中：
1. 点击父部门行的 "新增子部门" 按钮（带圈的+号）
2. 填写子部门信息
3. 系统会自动设置父子关系

### Q2: 用户没有显示部门怎么办？

**A:** 在用户管理界面编辑用户，选择合适的部门即可。

### Q3: 如何查看角色可以管理哪些部门？

**A:** 
1. 在角色管理界面查看 "数据范围" 列
2. 创建/编辑角色时查看数据权限说明
3. 数据范围决定了该角色用户可以访问的部门范围

### Q4: 为什么有些用户看不到其他部门的数据？

**A:** 这是由用户角色的数据范围决定的：
- 如果角色设置为 "仅本部门"，用户只能看到自己所在部门的数据
- 如果需要查看其他部门，需要调整角色的数据范围或为用户分配更高权限的角色

### Q5: 一个用户可以属于多个部门吗？

**A:** 不可以。每个用户只能属于一个部门，但可以拥有多个角色。

## 权限配置流程

正确的配置顺序：

```
1. 创建部门结构
   ↓
2. 创建角色（设置数据范围）
   ↓
3. 为角色分配功能权限（菜单和按钮）
   ↓
4. 创建用户（分配部门和角色）
   ↓
5. 测试权限是否符合预期
```

## 技术实现

### 数据库结构

```sql
-- 部门表
sys_dept (id, parent_id, ancestors, dept_name, dept_code, ...)

-- 角色表
sys_role (id, role_name, role_code, data_scope, ...)

-- 用户表
sys_user (id, username, dept_id, ...)

-- 用户角色关联表
sys_user_role (user_id, role_id)
```

### 数据权限SQL过滤

系统会根据用户的角色和数据范围自动生成SQL过滤条件：

```sql
-- data_scope = 1 (全部数据): 不添加过滤条件

-- data_scope = 2 (本部门及下级):
AND (u.dept_id = #{userDeptId} 
     OR u.dept_id IN (SELECT id FROM sys_dept WHERE FIND_IN_SET(#{userDeptId}, ancestors)))

-- data_scope = 3 (仅本部门):
AND u.dept_id = #{userDeptId}

-- data_scope = 4 (仅本人):
AND u.id = #{userId}
```

## 总结

理解部门、角色、用户三者的关系是正确使用系统的关键：

1. **部门**：定义组织结构和层级关系
2. **角色**：定义权限范围（通过 data_scope 字段）
3. **用户**：隶属于部门，拥有角色权限

**核心公式：** 用户实际权限 = 所在部门 + 角色数据范围 + 角色功能权限

正确配置这三者，就能实现灵活而安全的权限管理体系。
